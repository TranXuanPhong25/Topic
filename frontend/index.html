<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Happy Health Clinic - Virtual Assistant</title>
   <link rel="stylesheet" href="styles.css">
   <script src="chat.js"></script>
   <style>
      /* Medical Clinic Chat Interface Styles */

      :root {
         --primary-color: #2563eb;
         --primary-dark: #1e40af;
         --secondary-color: #10b981;
         --background: #f8fafc;
         --card-background: #ffffff;
         --text-primary: #1e293b;
         --text-secondary: #64748b;
         --border-color: #e2e8f0;
         --bot-message-bg: #f1f5f9;
         --user-message-bg: #2563eb;
         --user-message-text: #ffffff;
         --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
         --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      * {
         margin: 0;
         padding: 0;
         box-sizing: border-box;
      }

      body {
         font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
         background: var(--background);
         color: var(--text-primary);
         line-height: 1.6;
      }

      .container {
         max-width: 1200px;
         margin: 0 auto;
         padding: 0 20px;
      }

      /* Header */
      .header {
         background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
         color: white;
         padding: 2rem 0;
         box-shadow: var(--shadow-lg);
      }

      .header h1 {
         font-size: 2rem;
         margin-bottom: 0.5rem;
      }

      .header .tagline {
         font-size: 1.1rem;
         opacity: 0.9;
      }

      /* Main Content */
      .main-content {
         padding: 2rem 0;
         min-height: calc(100vh - 300px);
      }

      /* Welcome Card */
      .welcome-card {
         background: var(--card-background);
         border-radius: 12px;
         padding: 2rem;
         margin-bottom: 2rem;
         box-shadow: var(--shadow-lg);
      }

      .welcome-card h2 {
         color: var(--primary-color);
         margin-bottom: 1rem;
      }

      .features {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
         gap: 1rem;
         margin-top: 1.5rem;
      }

      .feature {
         display: flex;
         align-items: center;
         gap: 0.75rem;
         padding: 1rem;
         background: var(--background);
         border-radius: 8px;
         border: 1px solid var(--border-color);
      }

      .feature .icon {
         font-size: 1.5rem;
      }

      /* Quick Actions */
      .quick-actions {
         background: var(--card-background);
         border-radius: 12px;
         padding: 2rem;
         margin-bottom: 2rem;
         box-shadow: var(--shadow-lg);
      }

      .quick-actions h3 {
         color: var(--primary-color);
         margin-bottom: 1rem;
      }

      .quick-buttons {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
         gap: 1rem;
      }

      .quick-btn {
         padding: 0.75rem 1rem;
         background: var(--background);
         border: 2px solid var(--border-color);
         border-radius: 8px;
         cursor: pointer;
         font-size: 0.95rem;
         transition: all 0.2s;
         font-weight: 500;
      }

      .quick-btn:hover {
         background: var(--primary-color);
         color: white;
         border-color: var(--primary-color);
         transform: translateY(-2px);
         box-shadow: var(--shadow);
      }

      /* Chat Widget */
      .chat-widget {
         position: fixed;
         bottom: 20px;
         right: 20px;
         width: 400px;
         max-width: calc(100vw - 40px);
         height: 600px;
         max-height: calc(100vh - 100px);
         background: var(--card-background);
         border-radius: 16px;
         box-shadow: var(--shadow-lg);
         display: flex;
         flex-direction: column;
         z-index: 1000;
         overflow: hidden;
      }

      .chat-widget.minimized {
         height: 60px;
      }

      .chat-header {
         background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
         color: white;
         padding: 1rem;
         display: flex;
         justify-content: space-between;
         align-items: center;
         border-radius: 16px 16px 0 0;
      }

      .chat-header-content {
         display: flex;
         align-items: center;
         gap: 0.75rem;
      }

      .status-indicator {
         width: 10px;
         height: 10px;
         background: var(--secondary-color);
         border-radius: 50%;
         animation: pulse 2s infinite;
      }

      @keyframes pulse {

         0%,
         100% {
            opacity: 1;
         }

         50% {
            opacity: 0.5;
         }
      }

      .chat-title {
         font-weight: 600;
      }

      .minimize-btn {
         background: none;
         border: none;
         color: white;
         font-size: 1.5rem;
         cursor: pointer;
         padding: 0;
         width: 30px;
         height: 30px;
         display: flex;
         align-items: center;
         justify-content: center;
         border-radius: 4px;
         transition: background 0.2s;
      }

      .minimize-btn:hover {
         background: rgba(255, 255, 255, 0.1);
      }

      /* Chat Messages */
      .chat-messages {
         flex: 1;
         overflow-y: auto;
         padding: 1rem;
         display: flex;
         flex-direction: column;
         gap: 1rem;
      }

      .chat-widget.minimized .chat-messages,
      .chat-widget.minimized .chat-input-container,
      .chat-widget.minimized .typing-indicator {
         display: none;
      }

      .message {
         display: flex;
         gap: 0.75rem;
         animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
         from {
            opacity: 0;
            transform: translateY(10px);
         }

         to {
            opacity: 1;
            transform: translateY(0);
         }
      }

      .message-avatar {
         font-size: 1.5rem;
         flex-shrink: 0;
      }

      .message-content {
         flex: 1;
      }

      .bot-message .message-content {
         background: var(--bot-message-bg);
         padding: 0.75rem 1rem;
         border-radius: 12px 12px 12px 4px;
      }

      .user-message {
         flex-direction: row-reverse;
      }

      .user-message .message-content {
         background: var(--user-message-bg);
         color: var(--user-message-text);
         padding: 0.75rem 1rem;
         border-radius: 12px 12px 4px 12px;
         text-align: right;
      }

      .message-content p {
         margin-bottom: 0.5rem;
      }

      .message-content p:last-child {
         margin-bottom: 0;
      }

      .message-time {
         font-size: 0.75rem;
         opacity: 0.7;
         display: block;
         margin-top: 0.25rem;
      }

      /* Chat Input */
      .chat-input-container {
         padding: 1rem;
         border-top: 1px solid var(--border-color);
         display: flex;
         gap: 0.5rem;
         background: var(--card-background);
      }

      .chat-input {
         flex: 1;
         border: 1px solid var(--border-color);
         border-radius: 8px;
         padding: 0.75rem;
         font-size: 0.95rem;
         resize: none;
         max-height: 100px;
         font-family: inherit;
      }

      .chat-input:focus {
         outline: none;
         border-color: var(--primary-color);
      }
      
      /* Image Upload Button */
      .upload-btn {
         background: var(--secondary-color);
         color: white;
         border: none;
         border-radius: 8px;
         width: 40px;
         height: 40px;
         cursor: pointer;
         display: flex;
         align-items: center;
         justify-content: center;
         transition: background 0.2s;
         font-size: 1.4rem;
         margin-right: 8px;
      }
      
      .upload-btn:hover {
         background: #059669;
      }
      
      /* Image Preview Area */
      .image-preview {
         padding: 10px;
         border-top: 1px solid var(--border-color);
         background: var(--bot-message-bg);
      }
      
      .preview-header {
         display: flex;
         justify-content: space-between;
         align-items: center;
         margin-bottom: 8px;
         font-size: 0.9rem;
         color: var(--text-secondary);
      }
      
      .remove-image-btn {
         background: #ef4444;
         color: white;
         border: none;
         border-radius: 50%;
         width: 24px;
         height: 24px;
         cursor: pointer;
         font-size: 1rem;
         display: flex;
         align-items: center;
         justify-content: center;
      }
      
      .remove-image-btn:hover {
         background: #dc2626;
      }
      
      .preview-image {
         max-width: 200px;
         max-height: 200px;
         border-radius: 8px;
         border: 2px solid var(--border-color);
      }

      .send-btn {
         background: var(--primary-color);
         color: white;
         border: none;
         border-radius: 8px;
         width: 40px;
         height: 40px;
         cursor: pointer;
         display: flex;
         align-items: center;
         justify-content: center;
         transition: background 0.2s;
      }

      .send-btn:hover {
         background: var(--primary-dark);
      }

      .send-btn:disabled {
         opacity: 0.5;
         cursor: not-allowed;
      }

      .send-icon {
         font-size: 1.2rem;
      }

      /* Typing Indicator */
      .typing-indicator {
         padding: 0 1rem 1rem;
         display: flex;
         gap: 0.5rem;
         align-items: center;
      }

      .typing-dot {
         width: 8px;
         height: 8px;
         background: var(--text-secondary);
         border-radius: 50%;
         animation: typing 1.4s infinite;
      }

      .typing-dot:nth-child(2) {
         animation-delay: 0.2s;
      }

      .typing-dot:nth-child(3) {
         animation-delay: 0.4s;
      }

      @keyframes typing {

         0%,
         60%,
         100% {
            transform: translateY(0);
         }

         30% {
            transform: translateY(-10px);
         }
      }

      /* Chat Toggle Button */
      .chat-toggle-btn {
         position: fixed;
         bottom: 20px;
         right: 20px;
         width: 60px;
         height: 60px;
         border-radius: 50%;
         background: var(--primary-color);
         color: white;
         border: none;
         font-size: 1.5rem;
         cursor: pointer;
         box-shadow: var(--shadow-lg);
         display: none;
         align-items: center;
         justify-content: center;
         transition: transform 0.2s;
      }

      .chat-toggle-btn:hover {
         transform: scale(1.1);
      }

      /* Footer */
      .footer {
         background: var(--text-primary);
         color: white;
         padding: 2rem 0;
         margin-top: 4rem;
         text-align: center;
      }

      .footer-note {
         margin: 1rem 0;
         padding: 1rem;
         background: rgba(239, 68, 68, 0.2);
         border-radius: 8px;
         display: inline-block;
      }

      .contact-info {
         margin-top: 1rem;
         opacity: 0.8;
      }

      /* Scrollbar Styling */
      .chat-messages::-webkit-scrollbar {
         width: 6px;
      }

      .chat-messages::-webkit-scrollbar-track {
         background: transparent;
      }

      .chat-messages::-webkit-scrollbar-thumb {
         background: var(--border-color);
         border-radius: 3px;
      }

      .chat-messages::-webkit-scrollbar-thumb:hover {
         background: var(--text-secondary);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
         .header h1 {
            font-size: 1.5rem;
         }

         .welcome-card {
            padding: 1.5rem;
         }

         .features {
            grid-template-columns: 1fr;
         }

         .quick-buttons {
            grid-template-columns: repeat(2, 1fr);
         }

         .chat-widget {
            width: calc(100vw - 20px);
            height: calc(100vh - 100px);
            bottom: 10px;
            right: 10px;
         }
      }

      @media (max-width: 480px) {
         .quick-buttons {
            grid-template-columns: 1fr;
         }
      }
   </style>
</head>

<body>
   <!-- Header -->
   <header class="header">
      <div class="container">
         <h1>üè• Happy Health Clinic</h1>
         <p class="tagline">Your Virtual Medical Assistant</p>
      </div>

   </header>

   <!-- Main Content -->
   <main class="main-content">
      <div class="container">
         <!-- Welcome Message -->
         <div class="welcome-card">
            <h2>Welcome! How can I help you today?</h2>
            <p>I can assist you with:</p>
            <div class="features">
               <div class="feature">
                  <span class="icon">üìÖ</span>
                  <span>Schedule Appointments</span>
               </div>
               <div class="feature">
                  <span class="icon">‚ùì</span>
                  <span>Answer Questions</span>
               </div>
               <div class="feature">
                  <span class="icon">‚ÑπÔ∏è</span>
                  <span>Clinic Information</span>
               </div>
               <div class="feature">
                  <span class="icon">üíä</span>
                  <span>Services & Insurance</span>
               </div>
            </div>
         </div>

         <!-- Quick Actions -->
         <div class="quick-actions">
            <h3>Quick Questions</h3>
            <div class="quick-buttons">
               <button class="quick-btn" onclick="sendQuickMessage('What are your hours?')">
                  üïê Hours
               </button>
               <button class="quick-btn" onclick="sendQuickMessage('Where are you located?')">
                  üìç Location
               </button>
               <button class="quick-btn" onclick="sendQuickMessage('Do you accept insurance?')">
                  üí≥ Insurance
               </button>
               <button class="quick-btn" onclick="sendQuickMessage('I need to schedule an appointment')">
                  üìÖ Book Appointment
               </button>
               <button class="quick-btn" onclick="sendQuickMessage('What services do you offer?')">
                  üè• Services
               </button>
               <button class="quick-btn" onclick="sendQuickMessage('How much does a visit cost?')">
                  üí∞ Pricing
               </button>
            </div>
         </div>

         <!-- Chat Widget -->
         <div class="chat-widget" id="chatWidget">
            <div class="chat-header">
               <div class="chat-header-content">
                  <span class="status-indicator"></span>
                  <span class="chat-title">Chat with Assistant</span>
               </div>
               <button class="minimize-btn" onclick="toggleChat()" aria-label="Minimize chat">‚àí</button>
            </div>

            <div class="chat-messages" id="chatMessages">
               <div class="message bot-message">
                  <div class="message-avatar">ü§ñ</div>
                  <div class="message-content">
                     <p>Hello! I'm your virtual assistant for Happy Health Clinic. How can I help you today?</p>
                     <span class="message-time">Just now</span>
                  </div>
               </div>
            </div>
            
            <!-- Image Preview Area -->
            <div id="imagePreview" class="image-preview" style="display: none;">
               <div class="preview-header">
                  <span>üì∏ Image selected</span>
                  <button onclick="removeImage()" class="remove-image-btn" title="Remove image">‚úï</button>
               </div>
               <img id="previewImg" src="" alt="Preview" class="preview-image">
            </div>

            <div class="chat-input-container">
               <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
               <button class="upload-btn" onclick="document.getElementById('imageInput').click()" title="Upload image" aria-label="Upload image">
                  üì∑
               </button>
               <textarea id="chatInput" class="chat-input" placeholder="Type your message here..." rows="1"
                  onkeypress="handleKeyPress(event)"></textarea>
               <button class="send-btn" onclick="sendMessage()" aria-label="Send message">
                  <span class="send-icon">‚û§</span>
               </button>
            </div>

            <div class="typing-indicator" id="typingIndicator" style="display: none;">
               <div class="typing-dot"></div>
               <div class="typing-dot"></div>
               <div class="typing-dot"></div>
            </div>
         </div>

         <!-- Chat Toggle Button (for mobile) -->
         <button class="chat-toggle-btn" onclick="toggleChat()" aria-label="Open chat">
            üí¨
         </button>
      </div>
   </main>

   <!-- Footer -->
   <footer class="footer">
      <div class="container">
         <p>&copy; 2025 Happy Health Clinic. All rights reserved.</p>
         <p class="footer-note">
            <strong>Emergency?</strong> Call 911 immediately.
            This chatbot is for general information and appointment scheduling only.
         </p>
         <p class="contact-info">
            üìû (555) 123-4567 | üìç 123 Main Street, Anytown, USA | üïê Mon-Fri 9AM-5PM, Sat 9AM-12PM
         </p>
      </div>
   </footer>
   <script>
      // Medical Clinic Chat Interface JavaScript

      // Configuration
      const API_BASE_URL = 'http://localhost:8000';
      let sessionId = generateSessionId();

      // Generate unique session ID
      function generateSessionId() {
         return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }

      // Get current time string
      function getCurrentTime() {
         const now = new Date();
         return now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
      }

      // Add message to chat
      function addMessage(content, isUser = false) {
         const messagesContainer = document.getElementById('chatMessages');
         const messageDiv = document.createElement('div');
         messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

         const avatar = document.createElement('div');
         avatar.className = 'message-avatar';
         avatar.textContent = isUser ? 'üë§' : 'ü§ñ';

         const contentDiv = document.createElement('div');
         contentDiv.className = 'message-content';

         // Parse markdown-style formatting
         const formattedContent = content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>');

         contentDiv.innerHTML = `
        <p>${formattedContent}</p>
        <span class="message-time">${getCurrentTime()}</span>
    `;

         messageDiv.appendChild(avatar);
         messageDiv.appendChild(contentDiv);
         messagesContainer.appendChild(messageDiv);

         // Scroll to bottom
         messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Show/hide typing indicator
      function setTypingIndicator(show) {
         const indicator = document.getElementById('typingIndicator');
         indicator.style.display = show ? 'flex' : 'none';

         if (show) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
         }
      }

      // Send message to API
      async function sendMessageToAPI(message) {
         try {
            const response = await fetch(`${API_BASE_URL}/ma/chat`, {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
               },
               body: JSON.stringify({
                  message: message,
                  session_id: sessionId
               })
            });

            if (!response.ok) {
               throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data.response;
         } catch (error) {
            console.error('Error sending message:', error);
            throw error;
         }
      }
      
      // Image handling
      let selectedImageData = null;
      
      function handleImageSelect(event) {
         const file = event.target.files[0];
         if (!file) return;
         // Validate file type
         if (!file.type.startsWith('image/')) {
            alert('Vui l√≤ng ch·ªçn file ·∫£nh (JPEG, PNG, etc.)');
            return;
         }
         
         // Validate file size (max 5MB)
         if (file.size > 5 * 1024 * 1024) {
            alert('·∫¢nh qu√° l·ªõn! Vui l√≤ng ch·ªçn ·∫£nh d∆∞·ªõi 5MB.');
            return;
         }
         
         // Convert to base64
         const reader = new FileReader();
         reader.onload = (e) => {
            selectedImageData = e.target.result;
            // Show preview
            document.getElementById('previewImg').src = selectedImageData;
            document.getElementById('imagePreview').style.display = 'block';
            
            // Update placeholder
            const input = document.getElementById('chatInput');
            input.placeholder = 'üì∏ Image selected. Describe your symptoms...';
         };
         reader.readAsDataURL(file);
      }
      
      function removeImage() {
         selectedImageData = null;
         document.getElementById('imagePreview').style.display = 'none';
         document.getElementById('imageInput').value = '';
         document.getElementById('chatInput').placeholder = 'Type your message here...';
      }
      
      // Send image with message to API
      async function sendImageToAPI(message, imageData) {
         try {
            const response = await fetch(`${API_BASE_URL}/ma/chat/image`, {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json',
               },
               body: JSON.stringify({
                  message: message || 'Vui l√≤ng ph√¢n t√≠ch ·∫£nh n√†y',
                  image: imageData,
                  session_id: sessionId
               })
            });

            if (!response.ok) {
               const errorData = await response.json();
               throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            return data.response;
         } catch (error) {
            console.error('Error sending image:', error);
            throw error;
         }
      }

      // Send message
      async function sendMessage() {
         const input = document.getElementById('chatInput');
         const message = input.value.trim();

         // Check if we have image or message
         if (!message && !selectedImageData) return;

         // Save image data BEFORE clearing (important!)
         const hasImage = selectedImageData !== null;
         const imageDataToSend = selectedImageData; // Store before clearing
         
         // Add user message to chat
         if (hasImage) {
            addMessage(`üì∏ [Image] ${message || 'Analyzing image...'}`, true);
         } else {
            addMessage(message, true);
         }
         
         input.value = '';

         // Clear image preview AFTER saving the data
         if (hasImage) {
            removeImage();
         }

         // Resize textarea back to 1 row
         input.rows = 1;

         // Show typing indicator
         setTypingIndicator(true);

         // Disable send button
         const sendBtn = document.querySelector('.send-btn');
         sendBtn.disabled = true;

         try {
            let response;
            
            // Call appropriate API - use saved image data
            if (hasImage) {
               response = await sendImageToAPI(message, imageDataToSend);
            } else {
               response = await sendMessageToAPI(message);
            }

            // Hide typing indicator
            setTypingIndicator(false);

            // Add bot response
            addMessage(response, false);
         } catch (error) {
            setTypingIndicator(false);
            addMessage('I apologize, but I\'m having trouble connecting right now. Please try again or call us at (555) 123-4567.', false);
         } finally {
            // Re-enable send button
            sendBtn.disabled = false;
            input.focus();
         }
      }

      // Send quick message
      function sendQuickMessage(message) {
         const input = document.getElementById('chatInput');
         input.value = message;
         sendMessage();

         // Scroll to chat widget
         const chatWidget = document.getElementById('chatWidget');
         chatWidget.scrollIntoView({ behavior: 'smooth', block: 'end' });
      }

      // Handle Enter key press
      function handleKeyPress(event) {
         if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
         }
      }

      // Toggle chat minimize/maximize
      function toggleChat() {
         const chatWidget = document.getElementById('chatWidget');
         chatWidget.classList.toggle('minimized');
      }

      // Auto-resize textarea
      document.addEventListener('DOMContentLoaded', () => {
         const textarea = document.getElementById('chatInput');

         textarea.addEventListener('input', function () {
            this.rows = 1;
            const rows = Math.min(5, Math.floor(this.scrollHeight / 24));
            this.rows = rows;
         });

         // Focus input on load
         textarea.focus();

         // Check API connection
         checkAPIConnection();
      });

      // Check API connection
      async function checkAPIConnection() {
         try {
            const response = await fetch(`${API_BASE_URL}/health`);
            if (response.ok) {
               console.log('‚úÖ Connected to clinic API');
            } else {
               console.warn('‚ö†Ô∏è API connection issue');
            }
         } catch (error) {
            console.error('‚ùå Cannot connect to API:', error);
            addMessage('‚ö†Ô∏è Note: I\'m currently in offline mode. Some features may be limited. Please call (555) 123-4567 for immediate assistance.', false);
         }
      }

      // Example: Load chat history on page load
      async function loadChatHistory() {
         try {
            const response = await fetch(`${API_BASE_URL}/chat/history/${sessionId}`);
            if (response.ok) {
               const data = await response.json();
               if (data.messages && data.messages.length > 0) {
                  // Display previous messages
                  data.messages.forEach(msg => {
                     if (msg.role !== 'system') {
                        addMessage(msg.content, msg.role === 'user');
                     }
                  });
               }
            }
         } catch (error) {
            console.log('No previous chat history');
         }
      }

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
         // Escape to minimize chat
         if (e.key === 'Escape') {
            const chatWidget = document.getElementById('chatWidget');
            if (!chatWidget.classList.contains('minimized')) {
               toggleChat();
            }
         }
      });

      // Handle visibility change (tab switching)
      document.addEventListener('visibilitychange', () => {
         if (!document.hidden) {
            // Page became visible, could refresh data here
            console.log('Tab is now visible');
         }
      });

      // Export functions for use in HTML
      window.sendMessage = sendMessage;
      window.sendQuickMessage = sendQuickMessage;
      window.handleKeyPress = handleKeyPress;
      window.toggleChat = toggleChat;

   </script>

</body>

</html>